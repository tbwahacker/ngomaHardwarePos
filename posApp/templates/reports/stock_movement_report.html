{% extends "posApp/base.html" %}
{% load static %}
{% load humanize %}
{% block pageContent %}
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="d-flex justify-content-between">
            <h4 class="card-title mb-0">Product Stock Movement Report</h4>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card p-3">
        <div class="mdc-layout-grid">
            <div class="mdc-layout-grid__inner">
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="from_date">From date:</label>
                    <input type="date" id="from_date" name="from_date" value={{defaultDates.start}} class="form-control">
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="to_date">To date:</label>
                    <input type="date" id="to_date" name="to_date" value={{defaultDates.end}} class="form-control">
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="supplier">Suppliers:</label>
                    <select id="supplier" name="supplier" class="form-select form-select-sm">
                        <option value=" ">All Suppliers</option>
                        {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="client">Customers:</label>
                    <select id="client" name="client" class="form-select form-select-sm">
                        <option value=" ">All Customers</option>
                        {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="product">Product:</label>
                    <select id="product" name="product" class="form-select form-select-sm">
                        <option value=" ">All Products</option>
                        {% for product in products %}
                            <option value="{{ product.id }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="employee">Stocked By:</label>
                    <select id="employee" name="employee" class="form-select form-select-sm">
                        <option value=" ">All Employees</option>
                        {% for employee in employees %}
                            <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }} ( {{ employee.username }} )</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 d-flex justify-content-end mb-3">
                    <button id="filter_button" class="btn btn-primary btn-sm" name="setDateRange.end">Filter</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="d-flex w-100 justify-content-end">
            <button class="btn btn-success bg-gradient border rounded-0 btn-sm me-1" type="button" id="print" data-id="{{ sale.id }}"><i class="mdi mdi-printer"></i> Print</button>
            <button class="btn btn-secondary bg-gradient border rounded-0 btn-sm" type="button" id="exportPDF" data-bs-dismiss="modal" data-id="{{ sale.id }}"><i class="mdi mdi-export"></i> Export</button>
            {% if user.is_staff %}
                    <button class="btn btn-warning bg-gradient border btn-sm ml-2 rounded-0" id="clear_stock_record">
                         <i class="mdi mdi-refresh"></i><span> Clear Entire Record</span>
                    </button>
            {% endif %}
        </div>
        <br>
        <br>
        <!-- Hidden input element for file upload -->
        <input type="file" id="file-input" accept=".xlsx, .xls, .csv" style="display: none;">
        <div class="d-flex justify-content-center mb-2">
            <form method="GET" action="{% url 'stocks-report' %}" id="search-form" class="w-50">
                <input type="text" name="q" id="search-input" class="form-control rounded-pill" placeholder="Search products..." value="{{ request.GET.q|default_if_none:'' }}">
                <input type="hidden" name="per_page" id="per_page" value="{{ per_page }}">
            </form>
        </div>
        <br>
        <div id="results">
        <div class="d-flex justify-content-between">
            <form method="GET" action="{% url 'stocks-report' %}" id="entries-form">
                <label for="per_page">Show</label>
                <select name="per_page" id="per_page-select">
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    <option value="150" {% if per_page == 150 %}selected{% endif %}>150</option>
                    <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                    <option value="250" {% if per_page == 250 %}selected{% endif %}>250</option>
                    <option value="300" {% if per_page == 300 %}selected{% endif %}>300</option>
                    <option value="350" {% if per_page == 350 %}selected{% endif %}>350</option>
                    <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
                    <option value="1000" {% if per_page == 1000 %}selected{% endif %}>1000</option>
                    <option value="1500" {% if per_page == 1500 %}selected{% endif %}>1500</option>
                    <option value="2000" {% if per_page == 2000 %}selected{% endif %}>2000</option>
                </select>
                entries
                <input type="hidden" name="q" value="{{ request.GET.q|default_if_none:'' }}">
            </form>
            <div>
                <p>Showing {{ start_index }} to {{ end_index }} of {{ total_entries }} entries</p>
            </div>
        </div>
        <br>
            {% if stock_movements %}
                <table id="receiptContent" class="table table-striped table-bordered">
                    <colgroup>
                        <col width="10%">
                        <col width="15%">
                        <col width="15%">
                        <col width="15%">
                        <col width="15%">
                        <col width="30%">
                    </colgroup>
{#                    <thead>#}
{#                        <tr>#}
{#                            <th class="text-center py-1">Date</th>#}
{#                            <th class="text-center py-1 fw-bold">Product</th>#}
{#                            <th class="text-center py-1">Open Stock</th>#}
{#                            <th class="text-center py-1">Purchased</th>#}
{#                            <th class="text-center py-1">Sold</th>#}
{#                            <th class="text-center py-1">Returned</th>#}
{#                            <th class="text-center py-1">In Stock</th>#}
{#                        </tr>#}
{#                    </thead>#}
{#                    <tbody>#}
{#                        {% for stock in stocks %}#}
{#                            <tr>#}
{#                                <td class="px-2 py-1 text-center">{{ stock.date_added|date:"M d Y" }}</td>#}
{#                                <td class="px-2 py-1 text-center fw-bold">{{ stock.product__name }}</td>#}
{#                                <td class="px-2 py-1 text-center">{{ stock.quantity_in_past|default:"-" }}</td>#}
{#                                <td class="px-2 py-1 text-center">{{ stock.total_purchased|default:"-" }}</td>#}
{#                                <td class="px-2 py-1 text-center">{{ stock.total_sold|default:"-" }}</td>#}
{#                                <td class="px-2 py-1 text-center">{{ stock.quantity_returned|default:"-" }}</td>#}
{#                                <td class="px-2 py-1 text-center">{{ stock.total_in_stock|default:"-" }}</td>#}
{#                            </tr>#}
{#                        {% endfor %}#}
{#                    </tbody>#}
                <thead>
                <tr>
                    <th class="px-2 py-1 text-start fw-bold">Date</th>
                    <th class="px-2 py-1 text-center fw-bold">Product</th>
                    <th class="px-2 py-1 text-end fw-bold">Initial Stock</th>
                    <th class="px-2 py-1 text-end fw-bold">Purchased Qty</th>
                    <th class="px-2 py-1 text-center fw-bold">Sold Qty</th>
                    <th class="px-2 py-1 text-end fw-bold">Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for item in stock_movements %}

                    <tr>
                        <td class="px-2 py-1 text-center">{{ item.date|date:"Y-m-d" }}</td>
                        <td class="px-2 py-1 text-center fw-bold">{{ item.product }}</td>
                        <td class="px-2 py-1 text-center">{% if item.initial_pieces > 0 %}{{ item.initial_stock }} and {{ item.initial_pieces }} Pcs{% else %}{{ item.initial_stock }}{% endif %}</td>
                        <td class="px-2 py-1 text-center">{{ item.purchased_quantity }}</td>
                        <td class="px-2 py-1 text-center">{{ item.sold_quantity }}</td>
                        <td class="px-2 py-1 text-end">{% if item.balance_pieces > 0 %}{{ item.balance }} and {{ item.balance_pieces }} Pcs{% else %}{{ item.balance }}{% endif %}</td>
                    </tr>
                {% endfor %}
{#                    <tr>#}
{#                          <td colspan="5" class="text-end fw-bold align-middle" style="font-style: oblique; color: #499C54;">Total Remained:</td>#}
{#                          <td class="text-end fw-bold px-2 py-1 align-middle overall-price-value">{{ total_remained }}</td>#}
{#                    </tr>#}
            </tbody>
                </table>
            {% else %}
                <p>No stocks found for the given criteria.</p>
            {% endif %}
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12 justify-content-center">
    <div class="pagination-container">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if stocks.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&per_page={{ per_page }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ stocks.previous_page_number }}&per_page={{ per_page }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}
                {% for num in stocks.paginator.page_range %}
                {% if stocks.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > stocks.number|add:-3 and num < stocks.number|add:3 %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}&per_page={{ per_page }}&q={{ request.GET.q|default_if_none:'' }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}
                {% if stocks.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ stocks.next_page_number }}&per_page={{ per_page }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ stocks.paginator.num_pages }}&per_page={{ per_page }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock pageContent %}

{% block ScriptBlock %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

<script>
$(function() {
    $('#supplier').select2({
        placeholder: "Please Select Supplier here",
        width: '100%'
    });
    $('#client').select2({
        placeholder: "Please Select Client here",
        width: '100%'
    });
    $('#product').select2({
        placeholder: "Please Select Product here",
        width: '100%'
    });
    $('#employee').select2({
        placeholder: "Please Select Employee here",
        width: '100%'
    });

    // Debounce function to limit the rate of execution of a function
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Autocomplete search with debounce
        $('#search-input').on('input', debounce(function() {
            var query = $(this).val();
            var perPage = $('#per_page').val();
            $.ajax({
                url: '{% url "stocks-report" %}',
                type: 'GET',
                data: {
                    q: query,
                    per_page: perPage
                },
                success: function(data) {
                    $('#items-list-container').html($(data).find('#items-list-container').html());
                    // Re-attach event handlers for action buttons after updating content
                    {#attachActionHandlers();#}
                },
                error: function() {
                    alert('An error occurred while searching.');
                }
            });
        }, 300)); // 300 milliseconds debounce delay

        // Handle per_page change
        $('#per_page-select').change(function() {
            $('#per_page').val($(this).val());
            $('#search-form').submit();
        });


});
$("#filter_button").click(function(event) {
    event.preventDefault();
    var formData = {
        from_date: $("#from_date").val(),
        to_date: $("#to_date").val(),
        supplier: $("#supplier").val().trim(),
        client: $("#client").val().trim(),
        employee: $("#employee").val().trim(),
        product: $("#product").val().trim(),
    };
    console.log(formData); // Log form data to the console for debugging
    $.ajax({
        url: '{% url "stocks-report" %}',
        type: 'GET',
        data: formData,
        success: function(data) {
            $("#results").html($(data).find("#results").html());
        },
        error: function() {
            alert('An error occurred.');
        }
    });
});
// Function to clear all record
$('#clear_stock_record').click(function() {
        if (confirm("Are you sure you want to clear entire stock movement record?")) {
            $.ajax({
                url: '{% url "clear_stock_record" %}', // You'll need to create a URL for this action
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('All stock movement records have been cleared.');
                        location.reload();
                    } else {
                        alert('Failed to clear stock movement records: ' + response.msg);
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred while clearing quantities: ' + error);
                }
            });
        }
    });
document.getElementById("print").addEventListener("click", function() {
    var head = $('head').clone();
    var bodyContent = $('#receiptContent').clone();

    // Remove the specified columns (2, 5, 6)
    {#bodyContent.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').remove();#}
    {#bodyContent.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').remove();#}

    var newDocument = $("<div>");
    var saleId = $(this).data('id');

    var styles = `
    @media print {
        @page {
            margin: 0;
        }
        body {
            background: #eee;
            margin-top: 20px;
        }
        .overall-total {
            text-align: center; /* Aligns text horizontally */
            vertical-align: middle; /* Aligns text vertically */
        }
    }`;
    head.append('<style>' + styles + '</style>');
    newDocument.append(head);
    newDocument.find('title').text("Sales ID "+saleId+" - Details");
    newDocument.append(bodyContent);

    var printWindow = window.open('', '_blank', "width=1200,height=1000,left=300,top=200");
    printWindow.document.write(newDocument.html());
    printWindow.document.close();

    setTimeout(() => {
        printWindow.print();
        setTimeout(() => {
            printWindow.close();
        }, 250);
    }, 300);
});

document.getElementById("exportPDF").addEventListener("click", function() {
    var saleId = $(this).data('id');
    const { jsPDF } = window.jspdf;

    // Hide the specified columns (2, 5, 6) temporarily
    var originalTable = $('#receiptContent');
    {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').hide();#}
    {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').hide();#}

    html2canvas(originalTable.get(0)).then(canvas => {
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL("image/png");
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 295; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        pdf.save("Customer-Sales-ID" + saleId + "-details.pdf");

        // Restore the hidden columns after PDF generation
        {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').show();#}
        {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').show();#}
    }).catch(error => {
        console.error("Error generating PDF: ", error);
        // Restore the hidden columns in case of an error
        {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').show();#}
        {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').show();#}
    });
});

</script>
<script src="{% static 'posApp/assets/invoice/js/jspdf.umd.min.js' %} "></script>
<script src="{% static 'posApp/assets/invoice/js/html2canvas.js' %}"></script>
{% endblock ScriptBlock %}
