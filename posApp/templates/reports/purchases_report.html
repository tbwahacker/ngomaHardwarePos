{% extends "posApp/base.html" %}
{% load static %}
{% load humanize %}
{% block pageContent %}
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="d-flex justify-content-between">
            <h4 class="card-title mb-0">Product Purchases Report</h4>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card p-3">
        <div class="mdc-layout-grid">
            <div class="mdc-layout-grid__inner">
                <!-- Filter Form -->
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="from_date">From date:</label>
                    <input type="date" id="from_date" name="from_date" value="{{defaultDates.start}}" class="form-control">
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="to_date">To date:</label>
                    <input type="date" id="to_date" name="to_date" value="{{defaultDates.end}}" class="form-control">
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="client">Supplier:</label>
                    <select id="client" name="client" class="form-select form-select-sm">
                        <option value=" ">All Suppliers</option>
                        {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}">{{ supplier.name }} {{ supplier.phone }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="product">Product:</label>
                    <select id="product" name="product" class="form-select form-select-sm">
                        <option value=" ">All Products</option>
                        {% for product in products %}
                            <option value="{{ product.id }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3">
                    <label for="employee">Sold By:</label>
                    <select id="employee" name="employee" class="form-select form-select-sm">
                        <option value=" ">All Employees</option>
                        {% for employee in employees %}
                            <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }} ( {{ employee.username }} )</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-12-phone mb-3 d-flex align-items-center mt-4">
                    <label for="last_10_purchases" class="mr-2">Last 10 Purchases:</label>
                    <input type="checkbox" id="last_10_purchases" name="last_10_purchases" class="form-check-input mt-0">
                </div>
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 d-flex justify-content-end mb-3">
                    <button id="filter_button" class="btn btn-primary btn-sm" name="setDateRange.end">Filter</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="d-flex w-100 justify-content-end">
            <button class="btn btn-success bg-gradient border rounded-0 btn-sm me-1" type="button" id="print" data-id="{{ sale.id }}"><i class="mdi mdi-printer"></i> Print</button>
            <button class="btn btn-secondary bg-gradient border rounded-0 btn-sm" type="button" id="exportPDF" data-bs-dismiss="modal" data-id="{{ sale.id }}"><i class="mdi mdi-export"></i> Export</button>
        </div>
        <br>
        <div id="results">
            {% if purchases %}
                <!-- Display Aggregated Purchases Data -->
                <table id="receiptContent" class="table table-striped table-bordered">
                    <colgroup>
                        <col width="5%">
                        <col width="20%">
                        <col width="20%">
                        <col width="25%">
                        <col width="30%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th class="text-center py-1">#</th>
                            <th class="text-center py-1">Date</th>
                            <th class="text-center py-1 fw-bold">Product</th>
                            <th class="text-center py-1">Total Quantity Sold</th>
                            <th class="text-end py-1">Total Purchases Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for purchase in purchases %}
                            <tr>
                                <td class="px-2 py-1 text-center">{{ forloop.counter }}</td>
                                <td class="px-2 py-1 text-center">{{ purchase.latest_date_added|date:"M d Y" }}</td>
                                <td class="px-2 py-1 text-center fw-bold">{{ purchase.product_id__name }}</td>
                                <td class="px-2 py-1 text-center">{{ purchase.total_quantity }}</td>
                                <td class="px-2 py-1 text-end">{{ purchase.total_purchases|intcomma }}</td>
                            </tr>
                        {% endfor %}
                        <tr>
                           <td colspan="4" class="text-end fw-bold align-middle" style="font-style: oblique; color: #499C54;">Overall Price:</td>
                           <td class="text-end fw-bold px-2 py-1 align-middle overall-price-value">{{ overall_total_price|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
            {% elif purchases_details %}
                <table class="table table-striped table-bordered">
                    <colgroup>
                        <col width="5%">
                        <col width="20%">
                        <col width="20%">
                        <col width="25%">
                        <col width="15%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th class="text-center py-1">Order#</th>
                            <th class="text-center py-1">Date</th>
                            <th class="text-center py-1 fw-bold">Product</th>
                            <th class="text-center py-1">Quantity</th>
                            <th class="text-end py-1">Unit Price</th>
                            <th class="text-end py-1">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for purchase in purchases_details %}
                            <tr>
                                <td class="px-2 py-1 text-center">{{ purchase.id }}</td>
                                <td class="px-2 py-1 text-center">{{ purchase.date_added|date:'Y-m-d H:i' }}</td>
                                <td class="px-2 py-1 text-center fw-bold">{{ purchase.product_name }}</td>
                                <td class="px-2 py-1 text-center">{{ purchase.purchasesitems_qty }}</td>
                                <td class="px-2 py-1 text-end">{{ purchase.purchasesitems_price }}</td>
                                <td class="px-2 py-1 text-end">{{ purchase.purchasesitems_total|intcomma }}</td>
                            </tr>
                        {% endfor %}
                        <tr>
                          <td colspan="5" class="text-end fw-bold align-middle" style="font-style: oblique; color: #499C54;">Overall Price:</td>
                          <td class="text-end fw-bold px-2 py-1 align-middle overall-price-value">{{ overall_total_price|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
            {% else %}
                <p>No purchases found for the given criteria.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock pageContent %}

{% block ScriptBlock %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<script>
$(function() {
    $('#client').select2({
        placeholder: "Please Select Supplier here",
        width: '100%'
    });
    $('#product').select2({
        placeholder: "Please Select Product here",
        width: '100%'
    });
    $('#employee').select2({
        placeholder: "Please Select Employee Method here",
        width: '100%'
    });
});

$("#filter_button").click(function(event) {
    event.preventDefault();
    var formData = {
        from_date: $("#from_date").val(),
        to_date: $("#to_date").val(),
        client: $("#client").val().trim(),
        employee: $("#employee").val().trim(),
        product: $("#product").val().trim(),
        last_10_purchases: $("#last_10_purchases").is(":checked")
    };
    console.log(formData); // Log form data to the console for debugging
    $.ajax({
        url: '{% url "purchases-report" %}',
        type: 'GET',
        data: formData,
        success: function(data) {
            $("#results").html($(data).find("#results").html());
        },
        error: function() {
            alert('An error occurred.');
        }
    });
});
document.getElementById("print").addEventListener("click", function() {
    var head = $('head').clone();
    var bodyContent = $('#receiptContent').clone();

    // Remove the specified columns (2, 5, 6)
    {#bodyContent.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').remove();#}
    {#bodyContent.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').remove();#}

    var newDocument = $("<div>");
    var saleId = $(this).data('id');

    var styles = `
    @media print {
        @page {
            margin: 0;
        }
        body {
            background: #eee;
            margin-top: 20px;
        }
        .overall-total {
            text-align: center; /* Aligns text horizontally */
            vertical-align: middle; /* Aligns text vertically */
        }
    }`;
    head.append('<style>' + styles + '</style>');
    newDocument.append(head);
    newDocument.find('title').text("Sales ID "+saleId+" - Details");
    newDocument.append(bodyContent);

    var printWindow = window.open('', '_blank', "width=1200,height=1000,left=300,top=200");
    printWindow.document.write(newDocument.html());
    printWindow.document.close();

    setTimeout(() => {
        printWindow.print();
        setTimeout(() => {
            printWindow.close();
        }, 250);
    }, 300);
});

document.getElementById("exportPDF").addEventListener("click", function() {
    var saleId = $(this).data('id');
    const { jsPDF } = window.jspdf;

    // Hide the specified columns (2, 5, 6) temporarily
    var originalTable = $('#receiptContent');
    {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').hide();#}
    {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').hide();#}

    html2canvas(originalTable.get(0)).then(canvas => {
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL("image/png");
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 295; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        pdf.save("Customer-Sales-ID" + saleId + "-details.pdf");

        // Restore the hidden columns after PDF generation
        {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').show();#}
        {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').show();#}
    }).catch(error => {
        console.error("Error generating PDF: ", error);
        // Restore the hidden columns in case of an error
        {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').show();#}
        {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').show();#}
    });
});

</script>
<script src="{% static 'posApp/assets/invoice/js/jspdf.umd.min.js' %} "></script>
<script src="{% static 'posApp/assets/invoice/js/html2canvas.js' %}"></script>
{% endblock ScriptBlock %}
