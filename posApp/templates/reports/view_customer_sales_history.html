{% extends "posApp/base.html" %}
{% load static %}
{% load humanize %}

{% block pageContent %}
<style>
    .back-to-sales-button {
        background-color: #0B5CD4 !important;
        color: white; /* Text color */
    }
    .overall-total {
        text-align: center; /* Aligns text horizontally */
        vertical-align: middle; /* Aligns text vertically */
    }
    .separator {
        border-top: 2px solid #ccc;
    }
</style>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Customer Sales History: {{ customer.name }} <label style="color: green;"></label> {% if last_balance > 0 %} <label style="color: #FF5122;"> Outstanding Loan: {{ last_balance|intcomma }} Tsh.</label> {% else %} <label style="color: limegreen;">No Outstanding Loan</label> {% endif %}</h4>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <br>
        <div class="d-flex w-100 justify-content-end">
            <button class="btn btn-success bg-gradient border rounded-0 btn-sm me-1" type="button" id="print" data-id="{{ customer.name }}"><i class="mdi mdi-printer"></i> Print</button>
            <button class="btn btn-secondary bg-gradient border rounded-0 btn-sm" type="button" id="exportPDF" data-bs-dismiss="modal" data-id="{{ customer.name }}"><i class="mdi mdi-export"></i> Export</button>
        </div>
        <br>
        <div class="d-flex justify-content-center">
            <form method="GET" action="{% url 'view-customer-sold-products' %}" id="search-form" class="w-50">
                <input type="text" name="q" id="search-input" class="form-control rounded-pill" placeholder="Search history..." value="{{ request.GET.q|default_if_none:'' }}">
                <input type="hidden" name="id" id="id" class="form-control rounded-pill" readonly value="{{ customer.id }}">
                <input type="hidden" name="per_page" value="{{ per_page }}">
            </form>
        </div>
        <br>

        <div class="table-responsive">
{#            <table class="table table-striped table-bordered">#}
            <table id="receiptContent" class="table table-bordered border-dark border-warning border-top-0 border-bottom border-top border-light">
                <colgroup>
                    <col width="5%">
                    <col width="15%">
                    <col width="15%">
                    <col width="10%">
                    <col width="10%">
                    <col width="10%">
                    <col width="10%">
                    <col width="10%">
                </colgroup>
                <thead>
                    <tr>
                        <th class="text-center fw-bold py-1">Date</th>
                        <th class="text-center fw-bold py-1">Product</th>
                        <th class="text-center fw-bold py-1">Quantity</th>
                        <th class="text-end fw-bold py-1">Unit Price</th>
                        <th class="text-end fw-bold py-1">Total Price</th>
                        <th class="text-center fw-bold py-1">Method</th>
                        <th class="text-end fw-bold py-1">Payment</th>
                        <th class="text-end fw-bold py-1">Balance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for history in histories %}
                    <tr>
                        <td class="px-2 py-1 text-center fw-bold">{{ history.date_added|date:"F d, Y" }}</td>
                        <td class="px-2 py-1 text-center">{{ history.items.first.product_id.name }}</td>
                        <td class="px-2 py-1 text-center align-top">{% if history.items.first.pcs > 0 %}{{ history.items.first.qty }} and {{ history.items.first.pcs }} Pcs {% else %}{{ history.items.first.qty }}{% endif %}</td>
                        {% if is_direct_pricing %}
                        <td class="px-2 py-1 text-end">{{ history.items.first.price|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ history.items.first.total|intcomma }}</td>
                        {% else %}
                        <td class="px-2 py-1 text-end">{{ history.items.first.tendered_price|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ history.items.first.total_tendered_price|intcomma }}</td>
                        {% endif %}
                        {% if history.items|length > 1 %}
                            <td></td>
                            <td></td>
                            <td></td>
                        {% else %}
                            <td class="px-2 py-1 text-center align-top">{{ history.payment_method.name }}</td>
                            {% if is_direct_pricing %}
                            <td class="px-2 py-1 text-end">{{ history.paid_amount|intcomma }}</td>
                            <td class="px-2 py-1 text-end fw-bold">{{ history.balance|intcomma }}</td>
                            {% else %}
                            <td class="px-2 py-1 text-end">{{ history.tendered_paid_amount|intcomma }}</td>
                            <td class="px-2 py-1 text-end fw-bold">{{ history.tendered_balance|intcomma }}</td>
                            {% endif %}
                        {% endif %}
                    </tr>
                    {% for item in history.items|slice:"1:" %}
                    <tr>
                        <td></td>
                        <td class="px-2 py-1 text-center">{{ item.product_id.name }}</td>
                        <td class="px-2 py-1 text-center align-top">{% if item.pcs > 0 %}{{ item.qty }} and {{ item.pcs }} Pcs {% else %}{{ item.qty }}{% endif %}</td>
                        {% if is_direct_pricing %}
                        <td class="px-2 py-1 text-end">{{ item.price|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ item.total|intcomma }}</td>
                        {% else %}
                        <td class="px-2 py-1 text-end">{{ item.tendered_price|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ item.total_tendered_price|intcomma }}</td>
                        {% endif %}
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    {% if forloop.last %} <!-- Only add this block if it's the last sale in loop -->
                    <tr>
                        <td></td>
                        <td colspan="2"></td>
                        <td class="text-end" style="font-style: oblique; color: #499C54">Total Sale:</td>
                        <td class="text-end fw-bold px-2 py-1">{{ history.total_items_sold|intcomma }}</td>
                        <td class="px-2 py-1 text-center align-top">{{ history.payment_method.name }}</td>
                        {% if is_direct_pricing %}
                        <td class="px-2 py-1 text-end">{{ history.paid_amount|intcomma }}</td>
                        <td class="px-2 py-1 text-end fw-bold">{{ history.balance|intcomma }}</td>
                        {% else %}
                        <td class="px-2 py-1 text-end">{{ history.tendered_paid_amount|intcomma }}</td>
                        <td class="px-2 py-1 text-end fw-bold">{{ history.tendered_balance|intcomma }}</td>
                        {% endif %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% if not forloop.last %}
                    <tr class="separator">
                        <td colspan="10"></td>
                    </tr>
                    {% endif %}
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center">No items found</td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="6"></td>
                        <td class="text-end" >Final Balance:</td>
                        {% if last_balance > 0 %}
                            <td class="text-end fw-bold px-2 py-1 align-middle" style="font-style: oblique; color: #FF5122">{{ last_balance|intcomma }}</td>
                            {% else %}
                            <td class="text-end fw-bold px-2 py-1 align-middle" style="font-style: oblique; color: #499C54">{{ last_balance|intcomma }}</td>
                        {% endif %}

                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12 justify-content-center">
            <div class="pagination-container">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if sales.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1&q={{ request.GET.q|default_if_none:'' }}" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ sales.previous_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}
                        {% for num in sales.paginator.page_range %}
                        {% if sales.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > sales.number|add:-3 and num < sales.number|add:3 %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ request.GET.q|default_if_none:'' }}">{{ num }}</a></li>
                        {% endif %}
                        {% endfor %}
                        {% if sales.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ sales.next_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ sales.paginator.num_pages }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock pageContent %}

{% block ScriptBlock %}
<script>
    $(function() {
        // Debounce function to limit the rate of execution of a function
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        // Autocomplete search with debounce
        $('#search-input').on('input', debounce(function() {
            var customerId = $('#id').val();
            var query = $(this).val();
            var perPage = $('#per_page').val();
            console.log(customerId)
            $.ajax({
                url: '{% url "view-customer-sold-products" %}',
                type: 'GET',
                data: {
                    q: query,
                    per_page: perPage,
                    id: customerId
                },
                success: function(data) {
                    $('#items-list-container').html($(data).find('#items-list-container').html());
                },
                error: function() {
                    alert('An error occurred while searching.');
                }
            });
        }, 300)); // 300 milliseconds debounce delay

        // Handle per_page change
        $('#per_page').change(function() {
            $('#per_page').val($(this).val());
            $('#search-form').submit();
        });

    });

document.getElementById("print").addEventListener("click", function() {
    var head = $('head').clone();
    var bodyContent = $('#receiptContent').clone();

    // Remove the specified columns (2, 5, 6)
    {#bodyContent.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').remove();#}
    {#bodyContent.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').remove();#}

    var newDocument = $("<div>");
    var saleId = $(this).data('id');

    var styles = `
    @media print {
        @page {
            margin: 0;
        }
        body {
            background: #eee;
            margin-top: 20px;
        }
        .overall-total {
            text-align: center; /* Aligns text horizontally */
            vertical-align: middle; /* Aligns text vertically */
        }
    }`;
    head.append('<style>' + styles + '</style>');
    newDocument.append(head);
    newDocument.find('title').text("Sales ID "+saleId+" - Details");
    newDocument.append(bodyContent);

    var printWindow = window.open('', '_blank', "width=1200,height=1000,left=300,top=200");
    printWindow.document.write(newDocument.html());
    printWindow.document.close();

    setTimeout(() => {
        printWindow.print();
        setTimeout(() => {
            printWindow.close();
        }, 250);
    }, 300);
});

document.getElementById("exportPDF").addEventListener("click", function() {
    var name = $(this).data('id');
    const { jsPDF } = window.jspdf;

    // Hide the specified columns (2, 5, 6) temporarily
    var originalTable = $('#receiptContent');
    {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').hide();#}
    {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').hide();#}

    html2canvas(originalTable.get(0)).then(canvas => {
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL("image/png");
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 295; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        pdf.save("Customer-Sales-" + name + "-details.pdf");

        // Restore the hidden columns after PDF generation
        {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').show();#}
        {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').show();#}
    }).catch(error => {
        console.error("Error generating PDF: ", error);
        // Restore the hidden columns in case of an error
        {#originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').show();#}
        {#originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').show();#}
    });
});

</script>
<script src="{% static 'posApp/assets/invoice/js/jspdf.umd.min.js' %} "></script>
<script src="{% static 'posApp/assets/invoice/js/html2canvas.js' %}"></script>
{% endblock ScriptBlock %}
