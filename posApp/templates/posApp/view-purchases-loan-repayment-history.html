{% extends "posApp/base.html" %}
{% load static %}
{% load humanize %}
{% block pageContent %}
<style>
    .back-to-purchases-button {
        background-color: #0B5CD4 !important;
        color: white; /* Text color */
        /* Add any additional styling as needed */
    }
    .overall-total {
        text-align: center; /* Aligns text horizontally */
        vertical-align: middle; /* Aligns text vertically */
    }
    @media print {
    .back-to-purchases-button {
        background-color: #0B5CD4 !important;
        color: white; /* Text color */
        /* Add any additional styling as needed */
    }
    .overall-total {
        text-align: center; /* Aligns text horizontally */
        vertical-align: middle; /* Aligns text vertically */
    }
    }
</style>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Loan History for Purchase ID: {{ purchase.id }}</h4>
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
    <div class="d-flex w-100 justify-content-end">
            <button class="btn btn-success bg-gradient border rounded-0 btn-sm me-1" type="button" id="print"><i class="mdi mdi-printer"></i> Print</button>
            <button class="btn btn-secondary bg-gradient border rounded-0 btn-sm" type="button" id="exportPDF" data-bs-dismiss="modal"><i class="mdi mdi-export"></i> Export</button>
        </div>
    <br>
    <div class="d-flex justify-content-center">
        <form method="GET" action="{% url 'view-loan-repayment-history' %}" id="search-form" class="w-50">
            <input type="text" name="q" id="search-input" class="form-control rounded-pill" placeholder="Search history..." value="{{ request.GET.q|default_if_none:'' }}" data-id="{{ purchase.id }}">
            <input type="hidden" name="id" id="id" class="form-control rounded-pill" readonly value="{{ purchase.id |default_if_none:''}}">
            <input type="hidden" name="per_page" value="{{ per_page }}">
        </form>
    </div><br>
        <div class="table-responsive" id="items-list-container">
   <div class="d-flex justify-content-between">
    <form method="GET" action="{% url 'view-loan-repayment-history' %}" id="entries-form">
        <label for="per_page">Show</label>
        <select name="per_page" id="per_page" onchange="document.getElementById('entries-form').submit()">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        </select>
        entries
        <input type="hidden" name="q" value="{{ request.GET.q|default_if_none:'' }}">
    </form>
    <div><p>Showing {{ start_index }} to {{ end_index }} of {{ total_entries }} entries</p></div>
</div>
<br>
            <table class="table table-striped table-bordered">
                <colgroup>
                    <col width="5%">
                    <col width="20%">
                    <col width="20%">
                    <col width="15%">
                    <col width="15%">
                    <col width="15%">
                    <col width="15%">
                </colgroup>
                <thead>
                    <tr>
                        <th class="text-center py-1">#</th>
                        <th class="text-center py-1">Date</th>
                        <th class="text-center py-1">Customer</th>
                        <th class="text-center py-1">Initial Loan</th>
                        <th class="text-center py-1">Paid Amount</th>
                        <th class="text-center py-1">Total Paid Amount</th>
                        <th class="text-center py-1">Outstanding Loan</th>
                    </tr>
                </thead>
                <tbody>
                    {% for history in due_payment_history_page %}
                    <tr>
                        <td class="px-2 py-1 text-center">{{ forloop.counter }}</td>
                        <td class="px-2 py-1 text-start">{{ history.date_added }}</td>
                        <td class="px-2 py-1 text-start">{{ history.purchase_id.customer.phone }}</td>
                        <td class="px-2 py-1 text-end">{{ history.initial_loan|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ history.paid_amount|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ history.total_paid_amount|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ history.disbursed_amount|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No items found</td>
                    </tr>
                    {% endfor %}
                    <tr>
                       <td colspan="4" class="text-end" style="font-style: oblique; color: #e52d27">Overall:</td>
                       <td class="px-2 py-1 text-end center-align overall-total">{{ overall_total|intcomma }}</td>
                        <td class="px-2 py-1 text-end center-align overall-total">{{ overall_total|intcomma }}</td>
                       <td class="px-2 py-1 text-end center-align overall-total">{{ new_disbursement|intcomma }}</td>
                    </tr>
                </tbody>
            </table>
</div>
         <!-- Pagination Controls -->
   <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12 justify-content-center">
    <div class="pagination-container">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if due_payment_history_page.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&q={{ request.GET.q|default_if_none:'' }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ due_payment_history_page.previous_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}
                {% for num in due_payment_history_page.paginator.page_range %}
                {% if due_payment_history_page.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > due_payment_history_page.number|add:-3 and num < due_payment_history_page.number|add:3 %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ request.GET.q|default_if_none:'' }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}
                {% if due_payment_history_page.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ due_payment_history_page.next_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ due_payment_history_page.paginator.num_pages }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
    </div>
</div>

{% endblock pageContent %}
{% block ScriptBlock %}

<script src="{% static 'posApp/assets/invoice/js/jspdf.umd.min.js' %} "></script>
<script src="{% static 'posApp/assets/invoice/js/html2canvas.js' %}"></script>
<script>

    $(function() {
        // Debounce function to limit the rate of execution of a function
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        // Autocomplete search with debounce
        $('#search-input').on('input', debounce(function() {
            var purchaseId = $(this).data('id'); // Correctly fetch the purchase ID
            var query = $(this).val();
            var perPage = $('#per_page').val();
            $.ajax({
                url: '{% url "view-loan-repayment-history" %}',
                type: 'GET',
                data: {
                    q: query,
                    per_page: perPage,
                    id: purchaseId // Ensure the purchase ID is included in the AJAX request
                },
                success: function(data) {
                    $('#items-list-container').html($(data).find('#items-list-container').html());
                    // Re-attach event handlers for action buttons after updating content
                    attachActionHandlers();
                },
                error: function() {
                    alert('An error occurred while searching.');
                }
            });
        }, 300)); // 300 milliseconds debounce delay

        // Handle per_page change
        $('#per_page-select').change(function() {
            $('#per_page').val($(this).val());
            $('#search-form').submit();
        });

    })

    document.getElementById("print").addEventListener("click", function() {
    var printContents = document.getElementById("items-list-container").innerHTML;
    var originalContents = document.body.innerHTML;
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
});

document.getElementById("exportPDF").addEventListener("click", function() {
    const { jsPDF } = window.jspdf;
    html2canvas(document.querySelector("#items-list-container")).then(canvas => {
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL("image/png");
        const imgWidth = 210;
        const pageHeight = 295;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        pdf.save("purchases-invoice.pdf");
    });
});

</script>
{% endblock ScriptBlock %}
