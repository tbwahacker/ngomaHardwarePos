{% extends "posApp/base.html" %}
{% load humanize %}
{% block pageContent %}
<style>
    .back-to-proformas-button {
        background-color: #0B5CD4 !important;
        color: white; /* Text color */
        /* Add any additional styling as needed */
    }
    .overall-total {
        text-align: center; /* Aligns text horizontally */
        vertical-align: middle; /* Aligns text vertically */
    }
</style>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Products for Proforma ID: {{ proforma.id }}</h4>
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
    <br>
    <div class="d-flex justify-content-center">
        <form method="GET" action="{% url 'view-proforma-products' %}" id="search-form" class="w-50">
            <input type="text" name="q" id="search-input" class="form-control rounded-pill" placeholder="Search proformas..." value="{{ request.GET.q|default_if_none:'' }}" data-id="{{ proforma.id }}">
            <input type="hidden" name="id" id="id" class="form-control rounded-pill" readonly value="{{ proforma.id |default_if_none:''}}">
            <input type="hidden" name="per_page" value="{{ per_page }}">
        </form>
    </div><br>
        <div class="table-responsive" id="items-list-container">
   <div class="d-flex justify-content-between">
    <form method="GET" action="{% url 'view-proforma-products' %}" id="entries-form">
        <label for="per_page">Show</label>
        <select name="per_page" id="per_page" onchange="document.getElementById('entries-form').submit()">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        </select>
        entries
        <input type="hidden" name="q" value="{{ request.GET.q|default_if_none:'' }}">
        <input type="hidden" name="id" id="id" class="form-control rounded-pill" readonly value="{{ customer.id |default_if_none:''}}">
    </form>
    <div><p>Showing {{ start_index }} to {{ end_index }} of {{ total_entries }} entries</p></div>
</div>
<br>
            <table class="table table-striped table-bordered">
                <colgroup>
                    <col width="20%">
                    <col width="20%">
                    <col width="20%">
                    <col width="15%">
                    <col width="15%">
                </colgroup>
                <thead>
                    <tr>
                        <th class="text-center py-1">Customer</th>
                        <th class="text-center py-1">Product Name</th>
                        <th class="text-center py-1">Quantity</th>
                        <th class="text-end py-1">Price</th>
                        <th class="text-end py-1">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        {% if item.proforma_id.customer %}
                            <td class="px-2 py-1 text-center">{{ item.proforma_id.customer.phone }}</td>
                        {% else %}
                            <td class="px-2 py-1 text-center">Unselected</td>
                        {% endif %}
                        <td class="px-2 py-1 text-center">{{ item.product_id.name }}</td>
                        <td class="px-2 py-1 text-center">{{ item.qty }}</td>
                        <td class="px-2 py-1 text-end">{{ item.price|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ item.total|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No items found</td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="4" class="text-end" style="font-style: oblique">Overall Total:</td>
                        <td class="px-2 py-1 text-end center-align overall-total">{{ product_totals|intcomma }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
         <!-- Pagination Controls -->
   <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12 justify-content-center">
    <div class="pagination-container">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if items.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&q={{ request.GET.q|default_if_none:'' }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ items.previous_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}
                {% for num in items.paginator.page_range %}
                {% if items.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > items.number|add:-3 and num < items.number|add:3 %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ request.GET.q|default_if_none:'' }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}
                {% if items.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ items.next_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ items.paginator.num_pages }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
    </div>
</div>

    <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="d-flex justify-content-between mb-2">
 <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <a href="{% url 'proformas-page' %}" class="mdc-button mdc-button--raised back-to-proformas-button">Back</a>
</div>
     <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded reprint" style="background-color: #499C54; color: #ffffff;" type="button" data-id="{{ proforma.id }}" title="Do Reprintt">
         <i class="material-icons mdc-button__icon">print</i>Reprint
    </button>
 </div>
    </div>
    </div>


{% endblock pageContent %}
{% block ScriptBlock %}
<script>
    $(function() {
        // Debounce function to limit the rate of execution of a function
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Autocomplete search with debounce
        $('#search-input').on('input', debounce(function() {
            var proformaId = $(this).data('id'); // Correctly fetch the proforma ID
            var query = $(this).val();
            var perPage = $('#per_page').val();

            $.ajax({
                url: '{% url "view-proforma-products" %}',
                type: 'GET',
                data: {
                    q: query,
                    per_page: perPage,
                    id: proformaId // Ensure the proforma ID is included in the AJAX request
                },
                success: function(data) {
                    $('#items-list-container').html($(data).find('#items-list-container').html());
                    // Re-attach event handlers for action buttons after updating content
                    attachActionHandlers();
                },
                error: function(error) {
                    console.log("An error occurred while searching.");
                }
            });
        }, 300)); // 300 milliseconds debounce delay

        // Handle per_page change
        $('#per_page-select').change(function() {
            $('#per_page').val($(this).val());
            $('#id').val($(this).val());
            $('#search-form').submit();
        });

        // Function to attach action button event handlers
        function attachActionHandlers() {
            $('.reprint').on('click', function() {
                var proformaId = $(this).data('id');
                window.location.href = "{% url 'create-custom-proforma' %}?id=" + proformaId;
            });
        }

        // Initial attachment of action button event handlers
        attachActionHandlers();
    });
</script>

{% endblock ScriptBlock %}
