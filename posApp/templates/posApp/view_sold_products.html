{% extends "posApp/base.html" %}
{% load static %}
{% load humanize %}
{% block pageContent %}
<style>
    .back-to-sales-button {
        background-color: #0B5CD4 !important;
        color: white; /* Text color */
        /* Add any additional styling as needed */
    }
    .overall-total {
        text-align: center; /* Aligns text horizontally */
        vertical-align: middle; /* Aligns text vertically */
    }
</style>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Products for Sale ID: {{ sale.id }}</h4>
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        {% if user.is_staff %}
            <div class="d-flex w-100 justify-content-end">
            {% if sale.status is not 1 %}
             <button class="btn btn-primary bg-gradient border rounded-0 btn-sm me-1" type="button" id="approve" data-id="{{ sale.id }}"><i class="mdi mdi-receipt"></i> Approve</button>
            {% endif %}
            {% if sale.status is 1 %}
             <button class="btn btn-danger bg-gradient border rounded-0 btn-sm me-1" type="button" id="unapprove" data-id="{{ sale.id }}"><i class="mdi mdi-reload"></i> Unapprove</button>
            {% endif %}
            <button class="btn btn-success bg-gradient border rounded-0 btn-sm me-1" type="button" id="print" data-id="{{ sale.id }}"><i class="mdi mdi-printer"></i> Print</button>
            <button class="btn btn-secondary bg-gradient border rounded-0 btn-sm" type="button" id="exportPDF" data-bs-dismiss="modal" data-id="{{ sale.id }}"><i class="mdi mdi-export"></i> Export</button>
        </div>
        {% endif %}
    <br>
    <div class="d-flex justify-content-center">
        <form method="GET" action="{% url 'view-sold-products' %}" id="search-form" class="w-50">
            <input type="text" name="q" id="search-input" class="form-control rounded-pill" placeholder="Search sales..." value="{{ request.GET.q|default_if_none:'' }}" data-id="{{ sale.id }}">
            <input type="hidden" name="id" id="id" class="form-control rounded-pill" readonly value="{{ sale.id |default_if_none:''}}">
            <input type="hidden" name="per_page" value="{{ per_page }}">
        </form>
    </div><br>
        <div class="table-responsive" id="items-list-container">
   <div class="d-flex justify-content-between">
    <form method="GET" action="{% url 'view-sold-products' %}" id="entries-form">
        <label for="per_page">Show</label>
        <select name="per_page" id="per_page" onchange="document.getElementById('entries-form').submit()">
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            <option value="300" {% if per_page == 300 %}selected{% endif %}>300</option>
            <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
        </select>
        entries
        <input type="hidden" name="q" value="{{ request.GET.q|default_if_none:'' }}">
        <input type="hidden" name="id" id="id" class="form-control rounded-pill" readonly value="{{ sale.id |default_if_none:''}}">
    </form>
    <div><p>Showing {{ start_index }} to {{ end_index }} of {{ total_entries }} entries</p></div>
</div>
<br>
            <table id="receiptContent" class="table table-striped table-bordered">
                <colgroup>
                    <col width="20%">
{#                    <col width="20%">#}
{#                    <col width="20%">#}
{#                    <col width="15%">#}
{#                    <col width="15%">#}
{#                    <col width="15%">#}
{#                    {% if sale.loan_status == 1 %}#}
{#                        <col width="15%">#}
{#                        <col width="15%">#}
{#                    {% endif %}#}
                </colgroup>
                <thead>
                    <tr>
                        <th class="text-center py-1">Date</th>
                        <th class="text-center py-1">Customer</th>
                        <th class="text-center py-1 fw-bold">Product</th>
                        <th class="text-center py-1">Quantity</th>
                        <th class="text-end py-1">Price</th>
                        <th class="text-end py-1">Total</th>
{#                        {% if sale.loan_status == 1 %}#}
{#                            <th class="text-end py-1">Total Paid</th>#}
{#                            <th class="text-end py-1">Outstanding Loan</th>#}
{#                        {% endif %}#}
                        {% if user.is_staff %}
                            <th class="text-center py-1">Action</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td class="px-2 py-1 text-center">{{ item.sale_id.date_added|date:'Y-m-d' }}</td>
                        {% if item.sale_id.customer %}
                            <td class="px-2 py-1 text-center">{{ item.sale_id.customer.phone }}</td>
                        {% else %}
                            <td class="px-2 py-1 text-start">Unselected</td>
                        {% endif %}
                        <td class="px-2 py-1 text-center fw-bold">{{ item.product_id.name }}</td>
                        <td class="px-2 py-1 text-center">{{ item.qty }}</td>
                        {% if company.is_direct_pricing_method %}
                        <td class="px-2 py-1 text-end">{{ item.price|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ item.total|intcomma }}</td>
                        {% else %}
                        <td class="px-2 py-1 text-end">{{ item.tendered_price|intcomma }}</td>
                        <td class="px-2 py-1 text-end">{{ item.total_tendered_price|intcomma }}</td>
                        {% endif %}
{#                        {% if sale.loan_status == 1 %}#}
{#                         <td class="px-2 py-1 text-end">{{ overall_total|intcomma }}</td>#}
{#                         <td class="px-2 py-1 text-end">{{ new_disbursement|intcomma }}</td>#}
{#                        {% endif %}#}
                        {% if user.is_staff %}
                            <td class="px-2 py-1 text-center">
                            <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded edit-data" type="button" data-id="{{ item.pk }}" title="Edit">
                                <i class="material-icons mdc-button__icon">edit</i>
                            </button>
                            {% if items|length > 1 %}
                            <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--danger mdc-ripple-upgraded delete-data" type="button" data-id="{{ item.pk }}" title="Delete">
                                <i class="material-icons mdc-button__icon">delete_outline</i>
                            </button>
                            {% endif  %}
                        </td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No items found</td>
                    </tr>
                    {% endfor %}
                    <tr>

                         {% if sale.loan_status == 0 %}
                             <td></td>
                             <td></td>
{#                             <td colspan="1" class="text-end" style="font-style: oblique">Change Amount:</td>#}
{#                            <td class="px-2 py-1 text-start center-align overall-total">{{ sale.amount_change|intcomma }}</td>#}
{#                             <td colspan="3" class="text-end" style="font-style: oblique">Tendered Amount:</td>#}
{#                            <td class="px-2 py-1 text-start center-align overall-total">{{ sale.tendered_amount|intcomma }}</td>#}
                             <td class="text-end" style="font-style: oblique">Total Quantity:</td>
                            <td class="px-2 py-1 text-center center-align overall-total">{{ item_counts }}</td>
                             <td colspan="1" class="text-end" style="font-style: oblique">Overall Total:</td>
                            <td class="px-2 py-1 text-end fw-bold center-align overall-total">{{ product_totals|intcomma }}</td>
                            <td class="px-2 py-1 center-align"><button class="btn btn-primary bg-gradient btn-sm rounded-20 add-data" id="create_new" data-id="{{ sale.id }}"><i class="mdi mdi-plus"></i><span> Add New</span></button></td>
                         {% endif %}


                        {% if sale.loan_status == 1 %}
                            <td></td>
                            <td></td>
                             <td class="text-end" style="font-style: oblique">Total Quantity:</td>
                            <td class="px-2 py-1 text-center center-align overall-total">{{ item_counts }}</td>
                           <td colspan="1" class="text-end" style="font-style: oblique">Overall Total:</td>
                           <td class="px-2 py-1 text-end fw-bold center-align overall-total">{{ product_totals|intcomma }}</td>
                           <td class="px-2 py-1 center-align"><button class="btn btn-primary bg-gradient btn-sm rounded-20 add-data" id="create_new" data-id="{{ sale.id }}"><i class="mdi mdi-plus"></i><span> Add New</span></button></td>

{#                          <td colspan="2" class="text-end" style="font-style: oblique; color: #e52d27">Overall Total Paid Loan:</td>#}
{#                           <td class="px-2 py-1 text-end fw-bold center-align overall-total">{{ overall_total|intcomma }}</td>#}
{#                             <td class="px-2 py-1 text-end center-align overall-total">{{ new_disbursement|intcomma }}</td>#}
                         {% endif %}
                    </tr>
                </tbody>
            </table>
        </div>
         <!-- Pagination Controls -->
   <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12 justify-content-center">
    <div class="pagination-container">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if items.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&q={{ request.GET.q|default_if_none:'' }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ items.previous_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}
                {% for num in items.paginator.page_range %}
                {% if items.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > items.number|add:-3 and num < items.number|add:3 %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ request.GET.q|default_if_none:'' }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}
                {% if items.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ items.next_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ items.paginator.num_pages }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{#     {% if sale.loan_status == 1 %}#}
{#     <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded view-history" style="background-color: #499C54; color: #ffffff;" type="button" data-id="{{ sale.id }}">#}
{#         View Repayments History#}
{#     <i class="material-icons mdc-button__icon">chevron_right</i>#}
{#    </button>#}
{#{% endif %}#}
    </div>
</div>

    <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="d-flex justify-content-between mb-2">
 <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <a href="{% url 'sales-page' %}" class="mdc-button mdc-button--raised back-to-sales-button">Back</a>
</div>
 <div class="d-flex w-10 justify-content-end">
     <div class="d-flex w-100 justify-content-between">
     {% if user.is_staff and sale.status is not 1%}
      <button class="btn btn-primary bg-gradient border rounded-0 btn-sm me-1 process-payment" type="button" id="process-payment" data-id="{{ sale.id }}"><i class="mdi mdi-printer"></i> process</button>
     {% endif %}
{#      {% if sale.loan_status == 1 and perms.posApp.view_loan_repayment %}#}
{#     <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded pay-loan" style="background-color: #499C54; color: #ffffff;" type="button" data-id="{{ sale.id }}" title="Do Loan Repayment">#}
{#         <i class="material-icons mdc-button__icon">reply_all</i>#}
{#         Loan Repayment#}
{#    </button>#}
{#{% endif %}#}
     </div>
 </div>

 </div>
    </div>
    </div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirm_modal2" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Message will be populated by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" id="reject" class="btn btn-secondary" style="background-color: #FF5122; color: #ffffff;">Reject Payment</button>
                <button type="button" id="confirm" class="btn btn-primary">Confirm Payment</button>
            </div>
        </div>
    </div>
</div>

{% endblock pageContent %}
{% block ScriptBlock %}
<script>
    $(function() {

        // Debounce function to limit the rate of execution of a function
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Autocomplete search with debounce
        $('#search-input').on('input', debounce(function() {
            var saleId = $(this).data('id'); // Correctly fetch the sale ID
            var query = $(this).val();
            var perPage = $('#per_page').val();

            $.ajax({
                url: '{% url "view-sold-products" %}',
                type: 'GET',
                data: {
                    q: query,
                    {#per_page: perPage,#}
                    id: saleId // Ensure the sale ID is included in the AJAX request
                },
                success: function(data) {
                    $('#items-list-container').html($(data).find('#items-list-container').html());
                    // Re-attach event handlers for action buttons after updating content
                    attachActionHandlers();
                },
                error: function(error) {
                    console.log("An error occurred while searching.");
                }
            });
        }, 300)); // 300 milliseconds debounce delay

        // Handle per_page change
        $('#per_page-select').change(function() {
            $('#per_page').val($(this).val());
            $('#id').val($(this).val());
            $('#search-form').submit();
        });

        // Function to attach action button event handlers
        function attachActionHandlers() {
            $('.process-payment').on('click', function() {
            var saleId = $(this).data('id');
            $.ajax({
                url: "{% url 'get-sale-status' %}",
                method: "GET",
                data: { id: saleId },
                dataType: "json",
                success: function(response) {
                    if (response.status === 0) {
                        showConfirmationModal(saleId, response.loan_status);
                    } else if (response.status === 1) {
                        window.location.reload();
                        console.error(error);
                        alert("An error occurred.");
                    }
                },
                error: function(xhr, status, error) {
                    console.error(error);
                    alert("An error occurred.");
                }
            });
            });

            $('.pay-loan').on('click', function() {
                var saleId = $(this).data('id');
                uni_modal("Do Loan Repayment", "{% url 'loan-repayment-modal' %}?id=" + saleId)
            });

            $('.view-history').on('click', function() {
                var saleId = $(this).data('id');
                window.location.href = "{% url 'view-loan-repayment-history' %}?id=" + saleId;
            });

            $(document).on('click', '.edit-data', function() {
            uni_modal("Edit Item", "{% url 'manage_pos_page' %}?id=" + $(this).data('id'), "modal-lg")
            });

            $(document).on('click', '.add-data', function() {
            uni_modal("Add Item", "{% url 'manage_pos_page' %}?add_item=1&id=" + $(this).data('id'), "modal-lg")
            });

            // Function to handle delete button click
            $(document).on('click', '.delete-data', function() {
             _conf("Are you sure to remove this Product?", "delete_product", [$(this).data('id')])
            });

            $('#unapprove').on('click', function() {
            var saleId = $(this).data('id');
            // Perform the AJAX request to unapprove the sale
           $.ajax({
               headers: {
               "X-CSRFToken": '{{csrf_token}}'
            },
            url: "{% url 'unapprove-sale' %}",  // Ensure the URL is correct for unapproving
            method: "POST",
            data: { id: saleId },
            dataType: "json",
            success: function(response) {
            if (response.status === 'success') {
                {#window.location.href = "{% url 'sales-page' %}";#}
                window.location.reload();
            } else {
                alert("An error occurred while unapproving the sale.");
            }
        },
        error: function(xhr, status, error) {
            console.error(error);
            alert("An error occurred.");
        }
    });
});
            document.getElementById("approve").addEventListener("click", function() {
    var saleId = $(this).data('id');
    $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: "{% url 'process-payment' %}",
                method: "POST",
                data: { id: saleId },
                dataType: "json",
                success: function(response) {
                    if (response.status === 'success') {
                        window.location.href = "{% url 'sales-page' %}";
                        window.location.reload();
                    } else {
                        alert("An error occurred.");
                    }
                },
                error: function(xhr, status, error) {
                    console.error(error);
                    alert("An error occurred.");
                }
            });
});


        }

        // Initial attachment of action button event handlers
        attachActionHandlers();
        function showConfirmationModal(saleId, loanStatus) {
            var message = loanStatus === 1 ? "Do Loan Repayment first. \n\nN.B if you press Reject Payment, the order will automatically returned to stock and there will no a means to reverse this action." : "Please confirm this payment.  \n\n N.B if you press Reject Payment, the order will automatically returned to stock and there will no a means to reverse this action.";
            $('#confirm_modal2 .modal-body').html('<p>' + message + '</p>');
            $('#confirm_modal2').modal('show');
            $('#reject').off('click').on('click', function() {
                    rejectPayment(saleId);
                });
            if (loanStatus === 1) {
                $('#confirm').off('click').on('click', function() {
                    alert("Repay your loan.");
                });
            }
            else {
                $('#confirm').off('click').on('click', function() {
                    processPayment(saleId);
                });
            }
        }

        function processPayment(saleId) {
            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: "{% url 'process-payment' %}",
                method: "POST",
                data: { id: saleId },
                dataType: "json",
                success: function(response) {
                    if (response.status === 'success') {
                        $('#confirm_modal2').modal('hide');
                        // Update the sales list
                          updateSalesList();
                           {#alert(response.message);#}
                          {#printReceiptModal(saleId);#}
                    } else {
                        alert("An error occurred.");
                    }
                },
                error: function(xhr, status, error) {
                    console.error(error);
                    alert("An error occurred.");
                }
            });
        }

        function rejectPayment(saleId) {
            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: "{% url 'reject-payment' %}",
                method: "POST",
                data: { id: saleId },
                dataType: "json",
                success: function(response) {
                    if (response.status === 'success') {
                        $('#confirm_modal2').modal('hide');
                        // Update the sales list
                          updateSalesList();
                           {#alert(response.message);#}
                          {#printReceiptModal(saleId);#}
                    } else {
                        alert("An error occurred.");
                    }
                },
                error: function(xhr, status, error) {
                    console.error(error);
                    alert("An error occurred.");
                }
            });
        }

        function updateSalesList() {
            window.location.href = "{% url 'sales-page' %}";
        }

    });
function delete_product($id) {
        start_loader();
        $.ajax({
            headers: {
                "X-CSRFToken": '{{csrf_token}}'
            },
            url: "{% url 'remove-product-in-sale' %}",
            method: "POST",
            data: {
                id: $id
            },
            dataType: "json",
            error: err => {
                console.log(err)
                alert_toast("An error occurred.", 'error');
                end_loader();
            },
            success: function(resp) {
                if (typeof resp == 'object' && resp.status == 'success') {
                    location.href="{% url 'sales-page' %}";
                } else {
                    alert_toast("An error occurred.", 'error');
                    end_loader();
                }
            }
        })
    }

document.getElementById("print").addEventListener("click", function() {
    var saleId = $(this).data('id');
    uni_modal("Order's Receipt", "{% url 'receipt_modal_without_price' %}?id=" + saleId);
});
{#document.getElementById("print").addEventListener("click", function() {#}
{#    var head = $('head').clone();#}
{#    var bodyContent = $('#receiptContent').clone();#}
{##}
{#    // Remove the specified columns (2, 5, 6)#}
{#    bodyContent.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').remove();#}
{#    bodyContent.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').remove();#}
{##}
{#    var newDocument = $("<div>");#}
{#    var saleId = $(this).data('id');#}
{##}
{#    var styles = `#}
{#    @media print {#}
{#        @page {#}
{#            margin: 0;#}
{#        }#}
{#        body {#}
{#            background: #eee;#}
{#            margin-top: 20px;#}
{#        }#}
{#        .overall-total {#}
{#            text-align: center; /* Aligns text horizontally */#}
{#            vertical-align: middle; /* Aligns text vertically */#}
{#        }#}
{#    }`;#}
{#    head.append('<style>' + styles + '</style>');#}
{#    newDocument.append(head);#}
{#    newDocument.find('title').text("Sales ID "+saleId+" - Details");#}
{#    newDocument.append(bodyContent);#}
{##}
{#    var printWindow = window.open('', '_blank', "width=1200,height=1000,left=300,top=200");#}
{#    printWindow.document.write(newDocument.html());#}
{#    printWindow.document.close();#}
{##}
{#    setTimeout(() => {#}
{#        printWindow.print();#}
{#        setTimeout(() => {#}
{#            printWindow.close();#}
{#        }, 250);#}
{#    }, 300);#}
{#});#}

document.getElementById("exportPDF").addEventListener("click", function() {
    var saleId = $(this).data('id');
    const { jsPDF } = window.jspdf;

    // Hide the specified columns (2, 5, 6) temporarily
    var originalTable = $('#receiptContent');
    originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').hide();
    originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').hide();

    html2canvas(originalTable.get(0)).then(canvas => {
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL("image/png");
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 295; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        pdf.save("Customer-Sales-ID" + saleId + "-details.pdf");

        // Restore the hidden columns after PDF generation
        originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').show();
        originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').show();
    }).catch(error => {
        console.error("Error generating PDF: ", error);
        // Restore the hidden columns in case of an error
        originalTable.find('th:nth-child(2), th:nth-child(5), th:nth-child(6), th:contains("Action")').show();
        originalTable.find('td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7)').show();
    });
});



</script>
<script src="{% static 'posApp/assets/invoice/js/jspdf.umd.min.js' %} "></script>
<script src="{% static 'posApp/assets/invoice/js/html2canvas.js' %}"></script>
{% endblock ScriptBlock %}
