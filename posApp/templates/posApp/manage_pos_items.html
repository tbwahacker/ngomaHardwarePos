{% load humanize %}

<div class="container-fluid">
    {% if item %}
        <form action="" id="item-form">
        <!-- Item form for editing an existing sales item -->
            <input type="hidden" name="id" value="{{ item.pk }}">

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="name" class="control-label">Item Name</label>
                        <input type="text" name="name" id="name" class="form-control form-control-sm rounded-0" value="{{ item.product_id.name }}" required readonly>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="quantity" class="control-label">Quantity</label>
                        <input type="number" name="quantity" id="quantity" class="form-control form-control-sm rounded-0" value="{{ item.qty }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="price" class="control-label">Selling Price</label>
                        <input type="text" name="price" id="price" class="form-control form-control-sm rounded-0" value="{{ item.tendered_price|intcomma }}" required>
                    </div>
                </div>
            </div>
        </form>
    {% elif products %}
        <form action="" id="add-item-form">
        <!-- Dropdown for selecting a product -->
            <input type="hidden" name="sale_id" value="{{ sale_id }}">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="product-select" class="control-label">Select Product</label>
                        <select name="product_id" id="product-select" class="form-control form-control-sm rounded-0" required>
                            <option value="" disabled selected>-- Select a product --</option>
                            {% if user.is_staff %}
                            {% for product in products %}
                                <option value="{{ product.pk }}">{{ product }} ==> {{ product.quantity }}</option>
                            {% endfor %}
                            {% else %}
                                {% for product in products %}
                                <option value="{{ product.pk }}">{{ product.name }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="quantity" class="control-label">Quantity</label>
                        <input type="number" name="quantity" id="quantity" class="form-control form-control-sm rounded-0" value="{{ item.qty }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="price" class="control-label">Selling Price</label>
                        <input type="text" name="price" id="price" class="form-control form-control-sm rounded-0" value="{{ item.tendered_price|intcomma }}" required>
                    </div>
                </div>
            </div>
        </form>
    {% endif%}

</div>

<script>
    function formatNumberWithCommas(value) {
        return value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function removeCommas(value) {
        return value.replace(/,/g, '');
    }

    document.getElementById('price').addEventListener('input', function(event) {
        let value = event.target.value;
        value = removeCommas(value);  // Remove any existing commas
        if (!isNaN(value) && value !== '') {  // Ensure the value is a number
            event.target.value = formatNumberWithCommas(value);
        }
    });

    $(function() {
        $('#product-select').select2({
        placeholder: "Please Select customer here",
        width: '100%',
        dropdownParent: $('#uni_modal')
       });

        $('#item-form').submit(function(e) {
            e.preventDefault();
            var _this = $(this)
            $('.err-msg').remove();
            var el = $('<div>')
            el.addClass("alert alert-danger err-msg")
            el.hide()
            if (_this[0].checkValidity() == false) {
                _this[0].reportValidity();
                return false;
            }

            // Remove commas from new_pay before submission
            var newPriceInput = document.getElementById('price');
            newPriceInput.value = removeCommas(newPriceInput.value);

            start_loader();
            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: "{% url 'save-pos' %}",
                data: new FormData($(this)[0]),
                cache: false,
                contentType: false,
                processData: false,
                method: 'POST',
                type: 'POST',
                dataType: 'json',
                error: err => {
                    console.log(err)
                    end_loader();
                },
                success: function(resp) {
                    if (typeof resp == 'object' && resp.status == 'success') {
                        el.removeClass("alert alert-danger err-msg")
                        location.reload()
                    // else if (resp.status == 'failed' && !!resp.msg)
                    } else if (resp.status == 'failed') {
                        el.text(resp.msg)
                        alert(resp.msg)
                        location.reload()
                    } else {
                        el.text("An error occurred", 'error');
                        alert("An error occurred","error")
                        location.reload()
                        end_loader();
                        console.err(resp)
                    }
                    _this.prepend(el)
                    el.show('slow')
                    $("html, body, .modal").scrollTop(0);
                    end_loader()
                }
            })
        })
    })

    $(function() {
        $('#add-item-form').submit(function(e) {
            e.preventDefault();
            var _this = $(this)
            $('.err-msg').remove();
            var el = $('<div>')
            el.addClass("alert alert-danger err-msg")
            el.hide()
            if (_this[0].checkValidity() == false) {
                _this[0].reportValidity();
                return false;
            }

            // Remove commas from new_pay before submission
            var newPriceInput = document.getElementById('price');
            newPriceInput.value = removeCommas(newPriceInput.value);
            start_loader();
            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: "{% url 'save-pos' %}",
                data: new FormData($(this)[0]),
                cache: false,
                contentType: false,
                processData: false,
                method: 'POST',
                type: 'POST',
                dataType: 'json',
                error: err => {
                    console.log(err)
                    end_loader();
                    alert(err);
                },
                success: function(resp) {
                    if (typeof resp == 'object' && resp.status == 'success') {
                        el.removeClass("alert alert-danger err-msg")
                        location.reload()
                    //} else if (resp.status == 'failed' && !!resp.msg) {
                    } else if (resp.status == 'failed') {
                        alert(resp.msg)
                        el.text(resp.msg)
                        location.reload()
                    } else {
                        el.text("An error occurred", 'error');
                        alert("An error occurred","error")
                        location.reload()
                        end_loader();
                        console.err(resp)
                    }
                    _this.prepend(el)
                    el.show('slow')
                    $("html, body, .modal").scrollTop(0);
                    end_loader()
                }
            })
        })
    })
</script>




{#{% load humanize %}#}
{#<div class="container-fluid">#}
{#    <form action="" id="item-form">#}
{#        <input type="hidden" name="id" value="{% if item.pk %}{{ item.pk }}{% endif %}">#}
{##}
{#        <div class="row">#}
{#            <div class="col-md-6">#}
{#                <div class="form-group mb-3">#}
{#                    <label for="name" class="control-label">Item Name</label>#}
{#                    <input type="text" name="name" id="name" class="form-control form-control-sm rounded-0" value="{% if item.product_id.name %}{{ item.product_id.name }}{% endif %}" required readonly>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <div class="row">#}
{#            <div class="col-md-6">#}
{#                <div class="form-group mb-3">#}
{#                    <label for="quantity" class="control-label">Quantity</label>#}
{#                    <input type="number" name="quantity" id="quantity" class="form-control form-control-sm rounded-0" value="{% if item.qty %}{{ item.qty }}{% endif %}" required>#}
{#                </div>#}
{#            </div>#}
{#            <div class="col-md-6">#}
{#                <div class="form-group mb-3">#}
{#                    <label for="price" class="control-label">Selling Price</label>#}
{#                    <input type="text" name="price" id="price" class="form-control form-control-sm rounded-0" value="{% if item.tendered_price %}{{ item.tendered_price|intcomma }}{% endif %}" required>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </form>#}
{#</div>#}
{#    <script>#}
{##}
{#        function formatNumberWithCommas(value) {#}
{#            return value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');#}
{#        }#}
{##}
{#       function removeCommas(value) {#}
{#            return value.replace(/,/g, '');#}
{#        }#}
{##}
{#        document.getElementById('price').addEventListener('input', function(event) {#}
{#           let value = event.target.value;#}
{#           value = removeCommas(value);  // Remove any existing commas#}
{#           if (!isNaN(value) && value !== '') {  // Ensure the value is a number#}
{#              event.target.value = formatNumberWithCommas(value);#}
{#            }#}
{#           });#}
{##}
{#        $(function() {#}
{##}
{#            $('#item-form').submit(function(e) {#}
{#                e.preventDefault();#}
{#                var _this = $(this)#}
{#                $('.err-msg').remove();#}
{#                var el = $('<div>')#}
{#                el.addClass("alert alert-danger err-msg")#}
{#                el.hide()#}
{#                if (_this[0].checkValidity() == false) {#}
{#                    _this[0].reportValidity();#}
{#                    return false;#}
{#                }#}
{##}
{#                // Remove commas from new_pay before submission#}
{#                var newPriceInput = document.getElementById('price');#}
{#                newPriceInput.value = removeCommas(newPriceInput.value);#}
{##}
{#                start_loader();#}
{#                $.ajax({#}
{#                    headers: {#}
{#                        "X-CSRFToken": '{{csrf_token}}'#}
{#                    },#}
{#                    url: "{% url 'save-pos' %}",#}
{#                    data: new FormData($(this)[0]),#}
{#                    cache: false,#}
{#                    contentType: false,#}
{#                    processData: false,#}
{#                    method: 'POST',#}
{#                    type: 'POST',#}
{#                    dataType: 'json',#}
{#                    error: err => {#}
{#                        console.log(err)#}
{#                        end_loader();#}
{#                    },#}
{#                    success: function(resp) {#}
{#                        if (typeof resp == 'object' && resp.status == 'success') {#}
{#                            el.removeClass("alert alert-danger err-msg")#}
{#                            location.reload()#}
{#                        } else if (resp.status == 'failed' && !!resp.msg) {#}
{#                            el.text(resp.msg)#}
{#                        } else {#}
{#                            el.text("An error occured", 'error');#}
{#                            end_loader();#}
{#                            console.err(resp)#}
{#                        }#}
{#                        _this.prepend(el)#}
{#                        el.show('slow')#}
{#                        $("html, body, .modal").scrollTop(0);#}
{#                        end_loader()#}
{#                    }#}
{#                })#}
{#            })#}
{#        })#}
{#    </script>#}