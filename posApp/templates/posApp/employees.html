{% extends "posApp/base.html" %}
{% block pageContent %}
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="card-title mb-0">Employees List</h4>
            <button class="btn btn-primary bg-gradient btn-sm rounded-0" id="create_new"><i class="mdi mdi-plus"></i><span> Add New</span></button>
        </div>
        <br>
        <div class="d-flex justify-content-center">
            <form method="GET" action="{% url 'employees-page' %}" id="search-form" class="w-50">
                <input type="text" name="q" id="search-input" class="form-control rounded-pill" placeholder="Search employee..." value="{{ request.GET.q|default_if_none:'' }}">
                <input type="hidden" name="per_page" value="{{ per_page }}">
            </form>
        </div>
    </div>
</div>
<div id="items-list-container" class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
         <div class="d-flex justify-content-between">
    <form method="GET" action="{% url 'employees-page' %}" id="entries-form">
        <label for="per_page">Show</label>
        <select name="per_page" id="per_page" onchange="document.getElementById('entries-form').submit()">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        </select>
        entries
        <input type="hidden" name="q" value="{{ request.GET.q|default_if_none:'' }}">
    </form>
    <div><p>Showing {{ start_index }} to {{ end_index }} of {{ total_entries }} entries</p></div>
</div>
<br>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <colgroup>
                    <col width="5%">
                    <col width="20%">
                    <col width="25%">
                    <col width="15%">
                    <col width="15%">
                </colgroup>
                <thead>
                    <tr>
                        <th class="text-center py-1">#</th>
                        <th class="text-center py-1">Username</th>
                        <th class="text-center py-1">Full Name</th>
                        <th class="text-center py-1">Email</th>
                        <th class="text-center py-1">Admin</th>
                        <th class="text-center py-1">Active</th>
                        <th class="text-center py-1">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
{#                        <td class="px-2 py-1 text-center">{{ user.id }}</td>#}
{#                        <td class="px-2 py-1 text-center">{{ forloop.counter }}</td>#}
                        <td class="px-2 py-1 text-center">{{ forloop.revcounter }}</td>
                        <td class="px-2 py-1 text-center">{{ user.username }}</td>
                        <td class="px-2 py-1 text-start">{{ user.first_name }} {{ user.last_name }}</td>
                        <td class="px-2 py-1 text-start">{{ user.email }}</td>
                        <td class="px-2 py-1 text-center">{% if user.is_staff %} Yes {% else %} No {% endif %}</td>
                        <td class="px-2 py-1 text-center">{% if user.is_active %} Yes {% else %} No {% endif %}</td>
                        <td class="px-2 py-1 text-center">
                            {% if user != request.user %}
                            <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded edit-data" type="button" data-id="{{ user.pk }}" title="Edit">
                                <i class="material-icons mdc-button__icon">edit</i>
                            </button>
                            <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--danger mdc-ripple-upgraded delete-data" type="button" data-id="{{ user.pk }}" title="Delete">
                                <i class="material-icons mdc-button__icon">deleteoutline</i>
                            </button>
                                {% else %}
                                <label for="is_active" class="control-label">You</label>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
    
    <!-- Pagination Controls -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12 justify-content-center">
    <div class="pagination-container">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if employee.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&q={{ request.GET.q|default_if_none:'' }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ employee.previous_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}
                {% for num in employee.paginator.page_range %}
                {% if employee.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > employee.number|add:-3 and num < employee.number|add:3 %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ request.GET.q|default_if_none:'' }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}
                {% if employee.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ employee.next_page_number }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ employee.paginator.num_pages }}&q={{ request.GET.q|default_if_none:'' }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock pageContent %}
{% block ScriptBlock %}
<script>

    $(function() {

        // Debounce function to limit the rate of execution of a function
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

       // Autocomplete search with debounce
        $('#search-input').on('input', debounce(function() {
            var query = $(this).val();
            var perPage = $('#per_page').val();
            $.ajax({
                url: '{% url "employees-page" %}',
                type: 'GET',
                data: {
                    q: query,
                    per_page: perPage
                },
                success: function(data) {
                    $('#items-list-container').html($(data).find('#items-list-container').html());
                    // Re-attach event handlers for action buttons after updating content
                    attachActionHandlers();
                },
                error: function() {
                    alert('An error occurred while searching.');
                }
            });
        }, 300)); // 300 milliseconds debounce delay

        // Handle per_page change
        $('#per_page-select').change(function() {
            $('#per_page').val($(this).val());
            $('#search-form').submit();
        });

        // Function to attach action button event handlers
        function attachActionHandlers() {
        $('#create_new').click(function() {
            uni_modal("Add New Employee", "{% url 'manage-employee-page' %}")
        })
        $('.edit-data').click(function() {
            uni_modal("Edit Employee", "{% url 'manage-employee-page' %}?id=" + $(this).attr('data-id'))
        })
        $('.delete-data').click(function() {
            _conf("Are you sure to delete this Employee?", "delete_employee", [$(this).attr('data-id')])
        })

        $('#uni_modal').on('shown.bs.modal', function() {
            $('#category_id').select2({
                placeholder: "Please Select Employee Here",
                width: '100%',
                dropdownParent: $('#uni_modal')
            })
        })
        }

        // Initial attachment of action button event handlers
        attachActionHandlers();
    })

    function delete_employee($id) {
        start_loader();
        $.ajax({
            headers: {
                "X-CSRFToken": '{{csrf_token}}'
            },
            url: "{% url 'delete-employee' %}",
            method: "POST",
            data: {
                id: $id
            },
            dataType: "json",
            error: err => {
                console.log(err)
                alert_toast("An error occured.", 'error');
                end_loader();
            },
            success: function(resp) {
                if (typeof resp == 'object' && resp.status == 'success') {
                    location.reload();
                } else {
                    alert_toast("An error occured.", 'error');
                    end_loader();
                }
            }
        })
    }
</script>
{% endblock ScriptBlock %}